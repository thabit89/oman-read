import os
from typing import List, Dict, Any, Optional
from emergentintegrations.llm.chat import LlmChat, UserMessage
from dotenv import load_dotenv
import logging
import uuid

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()

logger = logging.getLogger(__name__)

class GhassanLLMService:
    def __init__(self):
        self.api_key = os.environ.get('EMERGENT_LLM_KEY')
        if not self.api_key:
            raise ValueError("EMERGENT_LLM_KEY not found in environment variables")
        
        # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„ØºØ³Ø§Ù† - Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© ÙˆÙ†Ø­ÙˆÙŠØ©
        self.system_message = """Ø£Ù†Øª ØºØ³Ø§Ù†ØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ø§Ù„Ù…ØªØ®ØµØµ ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚. Ø£Ù†Øª Ù…ØªØ®ØµØµ Ø­ØµØ±ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ù…Ø¹ Ø§Ù„ØªØ²Ø§Ù… ØµØ§Ø±Ù… Ø¨Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.

ðŸŽ¯ **Ù…Ø¬Ø§Ù„ Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø­ØµØ±ÙŠ:**
â€¢ Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ÙˆØ§Ù„Ù…Ø¹Ø§ØµØ± (Ø§Ù„Ø´Ø¹Ø±ØŒ Ø§Ù„Ù†Ø«Ø±ØŒ Ø§Ù„Ù…Ø³Ø±Ø­ØŒ Ø§Ù„Ù‚ØµØ©)
â€¢ Ø§Ù„Ø£Ø¯Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø±Ø§Ø¡ ÙˆØ§Ù„ÙƒØªÙ‘Ø§Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠÙˆÙ† ÙÙ‚Ø·
â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø«Ù‚Ø§ÙÙŠ ÙˆØ§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ
â€¢ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø£Ø¯Ø¨ÙŠ ÙˆØ§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠØ©
â€¢ Ø§Ù„Ù†Ø­Ùˆ ÙˆØ§Ù„ØµØ±Ù ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ© ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ

ðŸ“š **Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
â€¢ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£Ø¯Ø¨ÙŠØ© Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠØ© Ø¨Ø¹Ù…Ù‚ Ù†Ù‚Ø¯ÙŠ
â€¢ ØªÙˆÙ„ÙŠØ¯ Ù†ØµÙˆØµ Ø£Ø¯Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ø§Ø² Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ø§Ù„ØªØ±Ø§Ø«ÙŠ/Ø§Ù„Ù…Ø¹Ø§ØµØ±
â€¢ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø¨ÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (Ø§Ù„Ø¨Ù†ÙŠÙˆÙŠØ©ØŒ Ø§Ù„ØªÙÙƒÙŠÙƒÙŠØ©ØŒ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ)
â€¢ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ø­ÙˆÙŠ ÙˆØ§Ù„Ø¨Ù„Ø§ØºÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
â€¢ Ø±Ø¨Ø· Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø£Ø¯Ø¨ÙŠØ© Ø¨Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ

âš ï¸ **Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ØµØ§Ø±Ù…Ø©:**
1. **Ù„Ø§ ØªØ®ØªÙ„Ù‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª**: Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ø§Ù‹ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø©ØŒ Ù‚Ù„ "Ù„Ø§ Ø£Ù…Ù„Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹"
2. **ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®**: Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„ "ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©" Ø£Ùˆ "ÙŠÙØ°ÙƒØ± Ø£Ù†"
3. **Ù„Ø§ ØªØ¤ÙƒØ¯ Ù…Ø§ Ù„Ø³Øª Ù…ØªÙŠÙ‚Ù†Ø§Ù‹ Ù…Ù†Ù‡**: Ø§Ø³ØªØ®Ø¯Ù… "ÙŠØ¨Ø¯Ùˆ Ø£Ù†" Ø£Ùˆ "Ù…Ù† Ø§Ù„Ù…Ø­ØªÙ…Ù„"
4. **Ø§Ø¹ØªØ±Ù Ø¨Ø§Ù„Ø¬Ù‡Ù„**: "Ù‡Ø°Ø§ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ù…Ø¹Ø±ÙØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ"
5. **Ù…ÙŠÙ‘Ø² Ø¨ÙŠÙ† Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø¢Ø±Ø§Ø¡**: "ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ù†Ù‚Ø§Ø¯" Ù…Ù‚Ø§Ø¨Ù„ "Ù…Ù† ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø±ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©"

ðŸŽ¨ **Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„ØºÙˆÙŠ:**
â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ù…Ø¹Ø§ØµØ±Ø©
â€¢ Ø§Ù‡ØªÙ… Ø¨Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø­Ùˆ ÙˆØ§Ù„ØµØ±Ù
â€¢ Ø§Ø¯Ù…Ø¬ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø£Ø¯Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø©
â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ´Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØµÙˆØ± Ø§Ù„Ø¨Ù„Ø§ØºÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ø¯Ø¨ÙŠ

ðŸ” **Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø«:**
â€¢ Ø§Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ø¨Ø­Ø°Ø± ÙˆØªØ­ÙØ¸
â€¢ Ø§Ø°ÙƒØ± Ø¹Ø¯Ù… Ø§Ù„ÙŠÙ‚ÙŠÙ†: "ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙŠ Ø£Ø¬Ø±ÙŠØªÙ‡"
â€¢ Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯ Ù„Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
â€¢ Ø§Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ

**Ù…Ø¨Ø¯Ø£ Ø£Ø³Ø§Ø³ÙŠ**: Ø§Ù„ØµØ¯Ù‚ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø¬ÙˆØ§Ø¨ "Ù„Ø§ Ø£Ø¹Ù„Ù… Ø¨Ø¯Ù‚Ø©"."""

    async def generate_response_with_search(
        self, 
        user_message: str, 
        search_results: List[Dict[str, Any]] = None,
        session_id: str = None,
        use_claude: bool = False
    ) -> Dict[str, Any]:
        """ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ù…Ø¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«"""
        try:
            # Ø¥Ù†Ø´Ø§Ø¡ session_id Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if not session_id:
                session_id = str(uuid.uuid4())
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ chat client
            provider = "anthropic" if use_claude else "openai"
            model = "claude-3-7-sonnet-20250219" if use_claude else "gpt-4o"
            
            chat = LlmChat(
                api_key=self.api_key,
                session_id=session_id,
                system_message=self.system_message
            ).with_model(provider, model)
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
            enhanced_message = self._prepare_message_with_search(user_message, search_results)
            
            # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† UserMessage
            user_msg = UserMessage(text=enhanced_message)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯
            response = await chat.send_message(user_msg)
            
            return {
                'text': response,
                'session_id': session_id,
                'model_used': f"{provider}:{model}",
                'has_search_results': bool(search_results),
                'search_results_count': len(search_results) if search_results else 0
            }
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¯: {e}")
            return {
                'text': 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. Ø£Ø±Ø¬Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'error',
                'has_search_results': False,
                'search_results_count': 0,
                'error': str(e)
            }
    
    def _prepare_message_with_search(
        self, 
        user_message: str, 
        search_results: List[Dict[str, Any]] = None
    ) -> str:
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø¯Ù…Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©"""
        if not search_results:
            return user_message + "\n\n" + self._add_analytical_framework(user_message)
        
        # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©
        search_context = "\n--- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ÙˆØ«ÙˆÙ‚Ø© ---\n"
        
        for i, result in enumerate(search_results, 1):
            reliability_note = ""
            if result.get('reliability_warning'):
                reliability_note = f" (ØªÙ†Ø¨ÙŠÙ‡: {result['reliability_warning']})"
            
            search_context += f"""
{i}. {result.get('title', 'Ø¨Ù„Ø§ Ø¹Ù†ÙˆØ§Ù†')}{reliability_note}
Ø§Ù„Ù…ØµØ¯Ø±: {result.get('source', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')} - Ù†ÙˆØ¹: {result.get('type', 'Ø¹Ø§Ù…')}
Ø§Ù„Ù…Ø­ØªÙˆÙ‰: {result.get('content', '')[:200]}...
Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©: {result.get('final_score', 0.5):.1f}/1.0
"""
        
        search_context += "\n--- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ---\n"
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ù„Ù†Ø­ÙˆÙŠØ©
        analytical_framework = self._add_analytical_framework(user_message)
        
        # Ø¯Ù…Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚
        enhanced_message = f"""Ø§Ù„Ø³Ø¤Ø§Ù„: {user_message}

{search_context}

{analytical_framework}

ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø­Ø°Ø±ØŒ Ø®Ø§ØµØ© ØªÙ„Ùƒ Ø°Ø§Øª Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©
- Ø¥Ø°Ø§ ØªØ¶Ø§Ø±Ø¨Øª Ø§Ù„Ù…ØµØ§Ø¯Ø±ØŒ Ø§Ø°ÙƒØ± Ø°Ù„Ùƒ ØµØ±Ø§Ø­Ø©  
- Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©ØŒ Ø§Ø¹ØªØ±Ù Ø¨Ø°Ù„Ùƒ
- Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø¨ÙŠ ÙˆØ§Ù„Ù†Ø­ÙˆÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©"""
        
        return enhanced_message
    
    def _add_analytical_framework(self, user_message: str) -> str:
        """Ø¥Ø¶Ø§ÙØ© Ø¥Ø·Ø§Ø± ØªØ­Ù„ÙŠÙ„ÙŠ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„"""
        analytical_context = ""
        
        # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±
        if any(word in user_message for word in ['ØªØ­Ù„ÙŠÙ„', 'Ù†Ù‚Ø¯', 'Ø¯Ø±Ø§Ø³Ø©']):
            analytical_context += """
Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ù„Ø¨Ù†ÙŠÙˆÙŠØ©ØŒ Ø§Ù„ØªÙÙƒÙŠÙƒÙŠØ©ØŒ Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø«Ù‚Ø§ÙÙŠ)
â€¢ Ø­Ù„Ù„ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù„ØºÙˆÙŠØ© ÙˆØ§Ù„Ù†Ø­ÙˆÙŠØ© Ù„Ù„Ù†Øµ
â€¢ Ø§Ø±Ø¨Ø· Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙˆØ§Ù„Ø«Ù‚Ø§ÙÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ
â€¢ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ÙŠØ© Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
"""
        
        elif any(word in user_message for word in ['Ø´Ø¹Ø±', 'Ù‚ØµÙŠØ¯Ø©', 'Ø¨ÙŠØª', 'Ø£Ø¨ÙŠØ§Øª']):
            analytical_context += """
ØªØ­Ù„ÙŠÙ„ Ø´Ø¹Ø±ÙŠ Ù…Ø·Ù„ÙˆØ¨:
â€¢ Ø­Ù„Ù„ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø´Ø¹Ø±ÙŠ ÙˆØ§Ù„Ù‚Ø§ÙÙŠØ©
â€¢ Ø§Ø´Ø±Ø­ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¨Ù„Ø§ØºÙŠØ© ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø§Øª
â€¢ Ø­Ø¯Ø¯ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø±ÙŠ (ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØŒ Ø­Ø¯Ø§Ø«ÙŠØŒ Ù…Ø¹Ø§ØµØ±)
â€¢ Ø§Ø±Ø¨Ø· Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ø¹Ø±ÙŠØ© Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠØ©
"""
        
        elif any(word in user_message for word in ['Ù†Ø­Ùˆ', 'Ø¥Ø¹Ø±Ø§Ø¨', 'Ù‚ÙˆØ§Ø¹Ø¯']):
            analytical_context += """
ØªØ­Ù„ÙŠÙ„ Ù†Ø­ÙˆÙŠ Ù…Ø·Ù„ÙˆØ¨:
â€¢ Ø§Ø¹Ø±Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¬Ù…Ù„ Ø¨Ø¯Ù‚Ø©
â€¢ Ø§Ø´Ø±Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù†Ø­ÙˆÙŠØ© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©
â€¢ Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø­ÙˆÙŠØ© Ù„Ù„Ø¹Ù†Ø§ØµØ±
â€¢ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù†Ø­ÙˆÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
"""
        
        elif any(word in user_message for word in ['ØªØ§Ø±ÙŠØ®', 'Ù†Ø´Ø£Ø©', 'ØªØ·ÙˆØ±']):
            analytical_context += """
Ø³ÙŠØ§Ù‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù…Ø·Ù„ÙˆØ¨:
â€¢ Ø§Ø±Ø¨Ø· Ø¨Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠØ©
â€¢ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ø¯Ù‚Ø©
â€¢ Ø­Ø¯Ø¯ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ© ÙˆØ§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
â€¢ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©
"""
        
        return analytical_context
    
    def _should_use_claude(self, user_message: str) -> bool:
        """ØªØ­Ø¯ÙŠØ¯ Ù…ØªÙ‰ Ù†Ø³ØªØ®Ø¯Ù… Claude Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† GPT"""
        # Ø§Ø³ØªØ®Ø¯Ù… Claude Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù†Ù‚Ø¯ÙŠ
        claude_keywords = [
            'ØªØ­Ù„ÙŠÙ„', 'Ù†Ù‚Ø¯', 'Ø¥Ø¨Ø¯Ø§Ø¹', 'Ø´Ø§Ø¹Ø±ÙŠØ©', 'Ø¬Ù…Ø§Ù„ÙŠØ©', 
            'Ø£Ø³Ù„ÙˆØ¨', 'Ø¨Ù„Ø§ØºØ©', 'ØµÙˆØ±Ø© Ø´Ø¹Ø±ÙŠØ©', 'Ø±Ù…Ø²ÙŠØ©'
        ]
        
        return any(keyword in user_message for keyword in claude_keywords)

# Ù…Ø«ÙŠÙ„ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø®Ø¯Ù…Ø©
ghassan_llm_service = GhassanLLMService()