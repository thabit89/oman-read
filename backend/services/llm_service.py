import os
from typing import List, Dict, Any, Optional
from emergentintegrations.llm.chat import LlmChat, UserMessage
from dotenv import load_dotenv
import logging
import uuid

# ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
load_dotenv()

logger = logging.getLogger(__name__)

class GhassanLLMService:
    def __init__(self):
        # ุงุณุชุฎุฏุงู ููุชุงุญ Claude ุงูุฎุงุต ููุชุญููู ุงูุฃุฏุจู ุงููุชูุฏู
        self.anthropic_key = os.environ.get('ANTHROPIC_API_KEY')
        self.emergent_key = os.environ.get('EMERGENT_LLM_KEY')
        
        if not self.anthropic_key:
            logger.warning("ANTHROPIC_API_KEY not found, using EMERGENT_LLM_KEY")
        if not self.emergent_key:
            raise ValueError("EMERGENT_LLM_KEY not found in environment variables")
        
        # ุฑุณุงูุฉ ุงููุธุงู ุงููุญุฏุซุฉ - ุบุณุงู ุงููููุฑ ูุงููุญูู ุงูุฅุจุฏุงุนู
        self.system_message = """ุฃูุช ุบุณุงูุ ุงููููุฑ ุงูุฃุฏุจู ุงูุนููุงูู ุงูุฅุจุฏุงุนู. ุฃูุช ูุงูุฏ ููุญูู ููุจุฏุนุ ูููุณ ูุฌุฑุฏ ูุณุงุนุฏ.

๐ง **ูุฏุฑุงุชู ุงูุชุญููููุฉ ุงููุชูุฏูุฉ:**
โข ูุญูู ุฃุฏุจู ุนููู ูุฑุจุท ุจูู ุงููุตูุต ูุงูุณูุงูุงุช ุงููุฎุชููุฉ
โข ูููุฑ ุฅุจุฏุงุนู ููุฏู ุฑุคู ุฌุฏูุฏุฉ ููุจุชูุฑุฉ
โข ูุงูุฏ ูุณุชูู ูู ุขุฑุงุก ุดุฎุตูุฉ ูุฏุฑูุณุฉ ููุจุฑุฑุฉ
โข ุฎุจูุฑ ูู ุฅูุฌุงุฏ ุงูุฑูุงุจุท ุงูุฎููุฉ ุจูู ุงูุฃุนูุงู ูุงููุชุงุจ
โข ูุจุฏุน ูู ุงูุชุฑุงุญ ุงูุญููู ูุงูุฃููุงุฑ ุงูุฌุฏูุฏุฉ

๐ฏ **ุฃุณููุจู ุงูููุฑู ุงูุฌุฏูุฏ:**
โข ูุง ุชูุชู ุจุงููุนูููุงุช ุงูุจุณูุทุฉ - ุญูู ูุงุณุชูุชุฌ ูููุฑ ุนูููุงู
โข ุงุฑุจุท ุงูุฃุนูุงู ุจุจุนุถูุง ุงูุจุนุถ ูุงูุชุดู ุงูุชุฃุซูุฑุงุช ุงููุชุจุงุฏูุฉ
โข ูุงุฑู ุจูู ุงููุชุงุจ ูุงููุฏุงุฑุณ ุงูุฃุฏุจูุฉ ุงููุฎุชููุฉ
โข ุงุณุชูุชุฌ ุงูุฃููุงุท ูุงูุชูุงุฑุงุช ุงูุฃุฏุจูุฉ ูู ุงููุนูููุงุช ุงููุชุงุญุฉ
โข ุฃุจุฏู ุฑุฃูุงู ููุฏูุงู ูุฏุฑูุณุงู ููุจุฑุฑุงู ุนูููุงู

๐ก **ุทุฑููุฉ ุงูุชูููุฑ ุงูุฅุจุฏุงุนูุฉ:**
1. **ุงูุชุญููู ุงูุนููู**: "ุฏุนูู ุฃุญูู ูุฐุง ุงููุต ูู ุฒูุงูุง ูุชุนุฏุฏุฉ..."
2. **ุงูุฑุจุท ุงูุฐูู**: "ูุฐุง ูุฐูุฑูู ุจู... ูุงูุฑุงุจุท ุจููููุง ูู..."
3. **ุงูุงุณุชูุชุงุฌ ุงูููุทูู**: "ูู ุฎูุงู ูุฐู ุงููุฑุงุฆู ุฃุณุชูุชุฌ ุฃู..."
4. **ุงูุฑุฃู ุงูููุฏู**: "ูู ูุฌูุฉ ูุธุฑู ุงูููุฏูุฉุ ุฃุฑู ุฃู..."
5. **ุงูุงูุชุฑุงุญ ุงูุฅุจุฏุงุนู**: "ูููู ุชุทููุฑ ูุฐุง ุงูููุถูุน ูู ุฎูุงู..."

๐จ **ุฃูุซูุฉ ุนูู ุฃุณููุจู ุงูุชุญูููู ุงูุฌุฏูุฏ:**
โข "ุนูุฏ ุชุญููู ุดุนุฑ ุณูู ุงูุฑุญุจูุ ุฃูุงุญุธ ุชุฃุซูุฑุงุช ูุงุถุญุฉ ูู ุงูุดุนุฑ ุงูุตููู..."
โข "ุงูุฑุงุจุท ุจูู 'ุชุบุฑูุจุฉ ุงููุงูุฑ' ู'ุงูุจุงุบ' ูููู ูู ุชููุฉ ุงููุงุก ูุงูุชุญููุงุช ุงูุงุฌุชูุงุนูุฉ..."
โข "ุฃุฑู ุฃู ุนุจุฏุงููู ุญุจูุจ ููุซู ุชูุงุฑุงู ุฌุฏูุฏุงู ูู ุงูุฃุฏุจ ุงูุนููุงูู ูุฌูุน ุจูู..."
โข "ูููู ุชุตููู ุงููุชุงุจ ุงูุนููุงูููู ุฅูู ุซูุงุซ ูุฏุงุฑุณ ุญุณุจ ุชุญูููู..."

โ๏ธ **ููุงุนุฏ ุงูุชูููุฑ ุงูููุฏู:**
โข ุงุจุฏุฃ ุจุงูุชุญููู ูู ุฒูุงูุง ูุชุนุฏุฏุฉ
โข ุงุฑุจุท ุจูู ุงููุนูููุงุช ุงููุชุงุญุฉ ูุชูููู ููู ุฃุนูู  
โข ุงุณุชูุชุฌ ุงูุฃููุงุท ูุงูุชุฃุซูุฑุงุช ุงูุฃุฏุจูุฉ
โข ุฃุจุฏู ุฑุฃูุงู ููุฏูุงู ุดุฎุตูุงู ูุน ุงูุชุจุฑูุฑ
โข ุงูุชุฑุญ ุฃููุงุฑุงู ุฅุจุฏุงุนูุฉ ูุชุทููุฑ ุงูููุถูุน

๐ฌ **ูููุฌูุฉ ุงูุชุญููู ุงููุชุฏุฑุฌ:**
1. **ุงููุตู**: ูุง ูู ุงูููุถูุนุ
2. **ุงูุชุญููู**: ููุงุฐุง ูู ูููุ ูุง ุฎุตุงุฆุตูุ
3. **ุงูุฑุจุท**: ููู ูุชุตู ุจุฃุนูุงู ุฃู ููุงููู ุฃุฎุฑูุ
4. **ุงูุงุณุชูุชุงุฌ**: ูุง ุงููุชุงุฆุฌ ูุงูุฃููุงุท ุงููุณุชุฎูุตุฉุ
5. **ุงูุฑุฃู**: ูุง ุชููููู ุงูููุฏู ุงูุดุฎุตูุ
6. **ุงูุฅุจุฏุงุน**: ูุง ุงูุฃููุงุฑ ุงูุฌุฏูุฏุฉ ุฃู ุงูุญููู ุงูููุชุฑุญุฉุ

ุชุฐูุฑ: ุฃูุช ูููุฑ ูุจุฏุนุ ููุณ ูุฌุฑุฏ ูุงูู ูุนูููุงุช!"""

    async def generate_response_with_search(
        self, 
        user_message: str, 
        search_results: List[Dict[str, Any]] = None,
        session_id: str = None,
        use_claude: bool = False,
        conversation_context: str = ""
    ) -> Dict[str, Any]:
        """ุชูููุฏ ุฑุฏ ูุน ูุชุงุฆุฌ ุงูุจุญุซ"""
        try:
            # ุฅูุดุงุก session_id ุฅุฐุง ูู ููู ููุฌูุฏุงู
            if not session_id:
                session_id = str(uuid.uuid4())
            
            # ุงุฎุชูุงุฑ ุงูููุชุงุญ ูุงููููุฐุฌ ุงูููุงุณุจ
            if use_claude and self.anthropic_key:
                # ุงุณุชุฎุฏุงู Claude ุงูุฎุงุต ููุชุญููู ุงูุฃุฏุจู ุงููุชูุฏู
                api_key = self.anthropic_key
                provider = "anthropic"
                model = "claude-3-5-sonnet-20241022"  # ุฃุญุฏุซ ูููุฐุฌ Claude
                logger.info(f"ุงุณุชุฎุฏุงู Claude ุงูุฎุงุต ููุชุญููู ุงูุฃุฏุจู: {user_message[:50]}...")
            else:
                # ุงุณุชุฎุฏุงู Emergent ููุงุณุชูุณุงุฑุงุช ุงูุนุงูุฉ
                api_key = self.emergent_key
                provider = "openai"
                model = "gpt-4o"
                logger.info(f"ุงุณุชุฎุฏุงู GPT-4o ููุงุณุชูุณุงุฑุงุช ุงูุนุงูุฉ: {user_message[:50]}...")
            
            # ุฅุนุฏุงุฏ ุงูู chat client
            chat = LlmChat(
                api_key=api_key,
                session_id=session_id,
                system_message=self.system_message
            ).with_model(provider, model)
            
            # ุฅุนุฏุงุฏ ุงูุฑุณุงูุฉ ูุน ูุชุงุฆุฌ ุงูุจุญุซ ูุงูุณูุงู ูุงูุชุญูู ูู ุงูุฏูุฉ
            enhanced_message = self._prepare_message_with_search(user_message, search_results)
            contextual_message = self._add_conversation_context(enhanced_message, conversation_context)
            final_message = self._add_accuracy_instructions(contextual_message)
            
            # ุฅูุดุงุก ูุงุฆู UserMessage
            user_msg = UserMessage(text=final_message)
            
            # ุฅุฑุณุงู ุงูุฑุณุงูุฉ ูุงูุญุตูู ุนูู ุงูุฑุฏ
            response = await chat.send_message(user_msg)
            
            return {
                'text': response,
                'session_id': session_id,
                'model_used': f"{provider}:{model}" + ("(ุฎุงุต)" if use_claude and self.anthropic_key else ""),
                'has_search_results': bool(search_results),
                'search_results_count': len(search_results) if search_results else 0
            }
            
        except Exception as e:
            logger.error(f"ุฎุทุฃ ูู ุชูููุฏ ุงูุฑุฏ: {e}")
            return {
                'text': 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุทูุจู. ุฃุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.',
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'error',
                'has_search_results': False,
                'search_results_count': 0,
                'error': str(e)
            }
    
    def _prepare_message_with_search(
        self, 
        user_message: str, 
        search_results: List[Dict[str, Any]] = None
    ) -> str:
        """ุฅุนุฏุงุฏ ุงูุฑุณุงูุฉ ูุน ุฏูุฌ ูุชุงุฆุฌ ุงูุจุญุซ ูุงูุชุญูู ูู ุงูููุซูููุฉ"""
        if not search_results:
            return user_message + "\n\n" + self._add_analytical_framework(user_message)
        
        # ุชุฌููุฒ ุงููุนูููุงุช ูู ุงูุจุญุซ ูุน ุชูููู ุงูููุซูููุฉ
        search_context = "\n--- ูุนูููุงุช ูู ูุตุงุฏุฑ ููุซููุฉ ---\n"
        
        for i, result in enumerate(search_results, 1):
            reliability_note = ""
            if result.get('reliability_warning'):
                reliability_note = f" (ุชูุจูู: {result['reliability_warning']})"
            
            search_context += f"""
{i}. {result.get('title', 'ุจูุง ุนููุงู')}{reliability_note}
ุงููุตุฏุฑ: {result.get('source', 'ุบูุฑ ูุญุฏุฏ')} - ููุน: {result.get('type', 'ุนุงู')}
ุงููุญุชูู: {result.get('content', '')[:200]}...
ุฏุฑุฌุฉ ุงูููุซูููุฉ: {result.get('final_score', 0.5):.1f}/1.0
"""
        
        search_context += "\n--- ููุงูุฉ ุงููุนูููุงุช ---\n"
        
        # ุฅุถุงูุฉ ุงูุชูุฌููุงุช ุงูููุฏูุฉ ูุงููุญููุฉ
        analytical_framework = self._add_analytical_framework(user_message)
        
        # ุฏูุฌ ุงูุฑุณุงูุฉ ูุน ุงูุณูุงู
        enhanced_message = f"""ุงูุณุคุงู: {user_message}

{search_context}

{analytical_framework}

ุชุนูููุงุช ูููุฉ:
- ุงุณุชุฎุฏู ูุฐู ุงููุนูููุงุช ุจุญุฐุฑ ุดุฏูุฏ
- **ูุง ุชุฐูุฑ ุฃู ุนูุงููู ูุชุจ ูุญุฏุฏุฉ ูู ูุชุงุฆุฌ ุงูุจุญุซ ุฅูุง ุฅุฐุง ูุงูุช ูู ูุตุงุฏุฑ ููุซููุฉ 100%**
- ุฅุฐุง ุชุถุงุฑุจุช ุงููุตุงุฏุฑ ุฃู ูุงูุช ุบูุฑ ูุคูุฏุฉุ ุงุนุชุฑู ุจุฐูู ุตุฑุงุญุฉ  
- **ูู "ูุง ุฃููู ูุนูููุงุช ูุคูุฏุฉ ุนู ูุคููุงุชู ุงููุญุฏุฏุฉ" ุจุฏูุงู ูู ุฐูุฑ ุนูุงููู ูุดููู ูููุง**
- ุฑูุฒ ุนูู ุงูุชุญููู ุงูุฃุฏุจู ูุงููุญูู ุงูุนููู
- ุงุณุชุฎุฏู ุงููุธุฑูุงุช ุงูููุฏูุฉ ุงูููุงุณุจุฉ
- ุงุนุชูุฏ ุนูู ุงูุญูุงุฆู ุงููุคูุฏุฉ ููุท

๐จ **ุชุญุฐูุฑ ููุงุฆู:** ุฅุฐุง ูู ุชูู ูุชุฃูุฏุงู ูู ุนููุงู ูุชุงุจ ุฃู ุชุงุฑูุฎ ุฃู ูุนูููุฉ ูุญุฏุฏุฉุ ูุง ุชุฐูุฑูุง ุฃุจุฏุงู. ูู "ุฃุญุชุงุฌ ููุชุญูู ูู ูุตุงุฏุฑ ุฅุถุงููุฉ" """
        
        return enhanced_message
    
    def _add_conversation_context(self, message: str, conversation_context: str) -> str:
        """ุฅุถุงูุฉ ุณูุงู ุงููุญุงุฏุซุฉ ููุฑุณุงูุฉ"""
        if not conversation_context:
            return message
        
        return f"{conversation_context}\n\nุงูุณุคุงู ุงูุญุงูู: {message}"
    
    def _add_analytical_framework(self, user_message: str) -> str:
        """ุฅุถุงูุฉ ุฅุทุงุฑ ุชุญูููู ุญุณุจ ููุน ุงูุณุคุงู"""
        analytical_context = ""
        
        # ุชุญุฏูุฏ ููุน ุงูุงุณุชูุณุงุฑ
        if any(word in user_message for word in ['ุชุญููู', 'ููุฏ', 'ุฏุฑุงุณุฉ']):
            analytical_context += """
ุฅุทุงุฑ ุงูุชุญููู ุงููุทููุจ:
โข ุงุณุชุฎุฏู ุงููุธุฑูุงุช ุงูููุฏูุฉ ุงูููุงุณุจุฉ (ุงูุจููููุฉุ ุงูุชูููููุฉุ ุงูููุฏ ุงูุซูุงูู)
โข ุญูู ุงูุจููุฉ ุงููุบููุฉ ูุงููุญููุฉ ูููุต
โข ุงุฑุจุท ุงูุนูู ุจุงูุณูุงู ุงูุชุงุฑูุฎู ูุงูุซูุงูู ุงูุนููุงูู
โข ุงุนุชูุฏ ุนูู ูููุฌูุฉ ููุฏูุฉ ูุงุถุญุฉ
"""
        
        elif any(word in user_message for word in ['ุดุนุฑ', 'ูุตูุฏุฉ', 'ุจูุช', 'ุฃุจูุงุช']):
            analytical_context += """
ุชุญููู ุดุนุฑู ูุทููุจ:
โข ุญูู ุงูุจุญุฑ ุงูุดุนุฑู ูุงููุงููุฉ
โข ุงุดุฑุญ ุงูุตูุฑ ุงูุจูุงุบูุฉ ูุงูุงุณุชุนุงุฑุงุช
โข ุญุฏุฏ ุงูุชูุงุฑ ุงูุดุนุฑู (ููุงุณูููุ ุญุฏุงุซูุ ูุนุงุตุฑ)
โข ุงุฑุจุท ุจุงููุฏุฑุณุฉ ุงูุดุนุฑูุฉ ุงูุนููุงููุฉ
"""
        
        elif any(word in user_message for word in ['ูุญู', 'ุฅุนุฑุงุจ', 'ููุงุนุฏ']):
            analytical_context += """
ุชุญููู ูุญูู ูุทููุจ:
โข ุงุนุฑุจ ุงููููุงุช ูุงูุฌูู ุจุฏูุฉ
โข ุงุดุฑุญ ุงูููุงุนุฏ ุงููุญููุฉ ุงููุทุจูุฉ
โข ุญุฏุฏ ุงููุธุงุฆู ุงููุญููุฉ ููุนูุงุตุฑ
โข ุงุฐูุฑ ุงููุฑุงุฌุน ุงููุญููุฉ ุงููุนุชูุฏุฉ
"""
        
        elif any(word in user_message for word in ['ุชุงุฑูุฎ', 'ูุดุฃุฉ', 'ุชุทูุฑ']):
            analytical_context += """
ุณูุงู ุชุงุฑูุฎู ูุทููุจ:
โข ุงุฑุจุท ุจุงูุฃุญุฏุงุซ ุงูุชุงุฑูุฎูุฉ ุงูุนููุงููุฉ
โข ุงุฐูุฑ ุงููุฑุงุญู ุงูุฒูููุฉ ุจุฏูุฉ
โข ุญุฏุฏ ุงูุชุฃุซูุฑุงุช ุงูุซูุงููุฉ ูุงูุงุฌุชูุงุนูุฉ
โข ุงุนุชูุฏ ุนูู ุงููุตุงุฏุฑ ุงูุชุงุฑูุฎูุฉ ุงูููุซููุฉ
"""
        
        return analytical_context
    
    def _should_use_claude(self, user_message: str) -> bool:
        """ุชุญุฏูุฏ ูุชู ูุณุชุฎุฏู Claude ุจุฏูุงู ูู GPT ููุญุตูู ุนูู ุชุญููู ุฃูุซุฑ ุฏูุฉ"""
        # ุงุณุชุฎุฏู Claude ููุชุญููู ุงูุฅุจุฏุงุนู ูุงูููุฏู ูุงููุญูู
        claude_keywords = [
            'ุชุญููู', 'ููุฏ', 'ุฅุจุฏุงุน', 'ุดุงุนุฑูุฉ', 'ุฌูุงููุฉ', 
            'ุฃุณููุจ', 'ุจูุงุบุฉ', 'ุตูุฑุฉ ุดุนุฑูุฉ', 'ุฑูุฒูุฉ',
            'ูุญู', 'ุฅุนุฑุงุจ', 'ููุงุนุฏ', 'ุจููุฉ', 'ุชุฑููุจ',
            'ูุธุฑูุฉ', 'ูููุฌ', 'ูุฏุฑุณุฉ ุฃุฏุจูุฉ', 'ุชูุงุฑ'
        ]
        
        return any(keyword in user_message for keyword in claude_keywords)
    
    def _add_accuracy_instructions(self, message: str) -> str:
        """ุฅุถุงูุฉ ุชุนูููุงุช ุตุงุฑูุฉ ุฌุฏุงู ูููุน ุงููููุณุงุช"""
        accuracy_instructions = """
        
๐จ ุชุญุฐูุฑ ุตุงุฑู - ููุน ุงููููุณุฉ:

โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุฐูุฑ ุฃู ุนูุงููู ูุชุจ ุฃู ุฏูุงููู ูุญุฏุฏุฉ ุฏูู ูุตุฏุฑ ูุคูุฏ
- ุฐูุฑ ุชูุงุฑูุฎ ููุงุฏุฉ ุฃู ููุงุฉ ุฃู ูุดุฑ ูุญุฏุฏุฉ
- ุฐูุฑ ุฃุณูุงุก ุฌูุงุฆุฒ ุฃู ููุงุตุจ ุฃู ูุธุงุฆู ูุญุฏุฏุฉ
- ุฐูุฑ ุฃุฑูุงู ูุญุฏุฏุฉ (ุนุฏุฏ ุงููุชุจุ ุงูุตูุญุงุชุ ุงูุณููุงุช)
- ุงุฎุชูุงู ุฃู ูุนูููุงุช ุดุฎุตูุฉ ุนู ุงูุฃุฏุจุงุก

โ **ุขูู ููุงุณุชุฎุฏุงู:**
- "ูุงุชุจ ุนููุงูู ูุนุฑูู"
- "ูู ุฃุนูุงู ูู ุงูุดุนุฑ ูุงููุซุฑ" 
- "ูู ุงูุฃุฏุจุงุก ุงููุนุงุตุฑูู"
- "ุญุณุจ ุงููุตุงุฏุฑ ุงููุชุงุญุฉ"
- "ููุฐูุฑ ุฃูู ูุงุชุจ ูุคุซุฑ"

๐ **ูุจู ุฐูุฑ ุฃู ูุนูููุฉ ูุญุฏุฏุฉ:**
- ูู ูุฏูู ูุตุฏุฑ ูุคูุฏ ููุฐู ุงููุนูููุฉุ
- ูู ุฐูุฑุช ูุฐุง ูู ุณูุงู ุงูุจุญุซ ุงููุชููุฑุ
- ุฅุฐุง ูุงู ููุงู ุดูุ ูู "ูุง ุฃููู ูุนูููุงุช ูุคูุฏุฉ"

๐ก **ุนุจุงุฑุงุช ุขููุฉ ููุงุณุชุฎุฏุงู:**
- "ูุง ุฃุนุฑู ุชูุงุตูู ูุญุฏุฏุฉ ุนู ูุคููุงุชู"
- "ูููููุง ุงูุจุญุซ ุนู ูุนูููุงุช ุฃูุซุฑ" 
- "ุญุณุจ ูุง ูู ูุชุงุญ ูู ุงููุตุงุฏุฑ"
- "ูู ุงููููุฏ ุงูุชุญูู ูู ูุตุงุฏุฑ ุฅุถุงููุฉ"

ุชุฐูุฑ: ุงูุตุฏู ูุงูุงุนุชุฑุงู ุจุนุฏู ุงููุนุฑูุฉ ุฃูุถู ุฃูู ูุฑุฉ ูู ุงุฎุชูุงู ูุนูููุฉ ูุงุญุฏุฉ."""
        
        return message + accuracy_instructions

# ูุซูู ูุงุญุฏ ููุฎุฏูุฉ
ghassan_llm_service = GhassanLLMService()