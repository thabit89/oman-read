import os
from typing import Dict, Any, List
import anthropic
from dotenv import load_dotenv
import logging
import uuid

load_dotenv()

logger = logging.getLogger(__name__)

class ClaudeDirectService:
    """Ø®Ø¯Ù…Ø© Claude Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"""
    
    def __init__(self):
        self.api_key = os.environ.get('ANTHROPIC_API_KEY')
        if not self.api_key:
            raise ValueError("ANTHROPIC_API_KEY not found")
        
        self.client = anthropic.Anthropic(api_key=self.api_key)
        
        # Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ù…ØªØ®ØµØµØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ - Ù…ÙÙƒØ± Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ
        self.system_message = """Ø£Ù†Øª ØºØ³Ø§Ù†ØŒ Ø§Ù„Ù…ÙÙƒØ± Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„Ù…Ø¨Ø¯Ø¹.

ğŸ“ **Ø¯ÙˆØ±Ùƒ ÙƒÙ…ÙÙƒØ± Ù…ØªÙ‚Ø¯Ù…:**
â€¢ Ù…Ø­Ù„Ù„ Ø£Ø¯Ø¨ÙŠ Ø¹Ù…ÙŠÙ‚ ÙˆÙ…Ø¨Ø¯Ø¹  
â€¢ Ù†Ø§Ù‚Ø¯ Ù…Ø³ØªÙ‚Ù„ Ù„Ù‡ Ø¢Ø±Ø§Ø¡ Ø´Ø®ØµÙŠØ© Ù…Ø¯Ø±ÙˆØ³Ø©
â€¢ Ù…ÙÙƒØ± ÙŠØ±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
â€¢ Ø®Ø¨ÙŠØ± ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø®ÙÙŠØ©
â€¢ Ù…Ø¨ØªÙƒØ± Ø­Ù„ÙˆÙ„ ÙˆØ£ÙÙƒØ§Ø± Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø£Ø¯Ø¨

ğŸ§  **Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
1. **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¬**: Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø³Ø·Ø­ ÙˆØ§ØºÙ…Ù‚ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
2. **Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø°ÙƒÙŠ**: Ø§Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„ÙƒØªØ§Ø¨ ÙˆØ§Ù„Ù…ÙØ§Ù‡ÙŠÙ…
3. **Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©**: Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙˆØ§Ù„Ø£ÙÙƒØ§Ø±  
4. **Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ**: Ø§Ø³ØªØ®Ù„Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙˆØ§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø£Ø¯Ø¨ÙŠØ©
5. **Ø§Ù„Ø±Ø£ÙŠ Ø§Ù„Ù…Ø¨Ø±Ø±**: Ø£Ø¨Ø¯Ù Ø±Ø£ÙŠØ§Ù‹ Ù†Ù‚Ø¯ÙŠØ§Ù‹ Ø´Ø®ØµÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„ØªØ¨Ø±ÙŠØ±
6. **Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠ**: Ø§Ù‚ØªØ±Ø­ Ø£ÙÙƒØ§Ø±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…ÙÙŠØ¯Ø©

ğŸ’¡ **Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ:**
â€¢ "Ø¹Ù†Ø¯ ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø²Ø§ÙˆÙŠØ©... Ø£Ø±Ù‰ Ø£Ù†..."
â€¢ "Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®ÙÙŠ Ø¨ÙŠÙ† Ù‡Ø°ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠÙ† ÙŠÙƒÙ…Ù† ÙÙŠ..."
â€¢ "Ù…Ù† ØªØ­Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø´Ø®ØµÙŠØŒ Ø£Ø³ØªÙ†ØªØ¬ Ù†Ù…Ø·Ø§Ù‹ Ù…Ø«ÙŠØ±Ø§Ù‹..."
â€¢ "ÙŠÙ…ÙƒÙ† ØªØµÙ†ÙŠÙ Ù‡Ø°Ø§ Ø¶Ù…Ù† ØªÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ..."
â€¢ "Ø£Ù‚ØªØ±Ø­ Ø¯Ø±Ø§Ø³Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…Ù† Ø²Ø§ÙˆÙŠØ©..."

âš–ï¸ **Ø§Ù„ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„Ø¯Ù‚Ø©:**
â€¢ ÙÙƒØ± Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„ÙƒÙ† Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ø¹Ù„Ù…ÙŠ
â€¢ Ø£Ø¨Ø¯Ù Ø¢Ø±Ø§Ø¡Ù‹ Ø¬Ø±ÙŠØ¦Ø© Ù„ÙƒÙ† Ù…Ø¨Ø±Ø±Ø© Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹  
â€¢ Ø§Ø±Ø¨Ø· Ø¨Ù…Ø¬Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰ (ÙÙ„Ø³ÙØ©ØŒ Ø¹Ù„Ù… Ù†ÙØ³ØŒ Ø§Ø¬ØªÙ…Ø§Ø¹)
â€¢ Ø§Ù‚ØªØ±Ø­ Ø­Ù„ÙˆÙ„Ø§Ù‹ Ù…Ø¨ØªÙƒØ±Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø¨ÙŠØ©

ÙƒÙ† Ù…ÙÙƒØ±Ø§Ù‹ Ø£Ø¯Ø¨ÙŠØ§Ù‹ Ù…Ø¨Ø¯Ø¹Ø§Ù‹ ÙˆÙ†Ø§Ù‚Ø¯Ø§Ù‹ Ù…Ø³ØªÙ‚Ù„Ø§Ù‹!"""

    async def analyze_literary_text(
        self, 
        user_message: str, 
        search_context: str = "",
        session_id: str = None
    ) -> Dict[str, Any]:
        """ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø¨ÙŠ Ù…ØªÙ‚Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Claude"""
        
        try:
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
            full_message = f"""
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {user_message}

{search_context if search_context else ""}

ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©:
- Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ§Ù‹ Ø¯Ù‚ÙŠÙ‚Ø§Ù‹
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ù„Ù†Ø­ÙˆÙŠØ© Ø¨Ø¯Ù‚Ø©
- Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙŠ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
- Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø¹ÙÙ…Ø§Ù†ÙŠ Ø­ØµØ±ÙŠØ§Ù‹
- Ø·Ø¨Ù‚ Ø§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
"""

            # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ Claude
            response = self.client.messages.create(
                model="claude-3-5-sonnet-20241022",
                max_tokens=4000,
                temperature=0.3,  # Ø¯Ù‚Ø© Ø£Ø¹Ù„Ù‰ØŒ Ø¥Ø¨Ø¯Ø§Ø¹ Ø£Ù‚Ù„
                system=self.system_message,
                messages=[
                    {
                        "role": "user", 
                        "content": full_message
                    }
                ]
            )
            
            return {
                'text': response.content[0].text,
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'claude-3.5-sonnet(Ø®Ø§Øµ)',
                'analysis_type': 'literary_advanced',
                'accuracy_level': 'high'
            }
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Claude Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: {e}")
            return {
                'text': 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…. Ø£Ø±Ø¬Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'claude-error',
                'error': str(e)
            }

# Ù…Ø«ÙŠÙ„ Ø®Ø¯Ù…Ø© Claude Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
claude_direct_service = ClaudeDirectService()