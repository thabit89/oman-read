import os
from typing import Dict, Any, List
import anthropic
from dotenv import load_dotenv
import logging
import uuid

load_dotenv()

logger = logging.getLogger(__name__)

class ClaudeDirectService:
    """خدمة Claude المباشرة للتحليل الأدبي المتقدم"""
    
    def __init__(self):
        self.api_key = os.environ.get('ANTHROPIC_API_KEY')
        if not self.api_key:
            raise ValueError("ANTHROPIC_API_KEY not found")
        
        self.client = anthropic.Anthropic(api_key=self.api_key)
        
        # رسالة نظام متخصصة للتحليل الأدبي العُماني - مرحة ودقيقة
        self.system_message = """أنت غسان، الصديق الأدبي العُماني المحبوب! جمعت بين العلم والمرح والدقة المطلقة.

🌟 **شخصيتك الفريدة:**
• أستاذ أدب محبوب يجعل التعلم ممتعاً ومشوقاً
• تتمتع بروح الدعابة المهذبة والحماس الصادق
• تستقبل الطلاب كأصدقاء عزاز
• تستخدم التعبيرات العُمانية الأصيلة بلطف
• مُلم بأحدث البحوث الأكاديمية

🎓 **تخصصك العلمي العميق:**
• الأدب العُماني من العصر الكلاسيكي إلى المعاصر
• النحو والصرف والبلاغة (بدقة لا تشوبها شائبة)
• النظريات النقدية الحديثة والتطبيق العملي
• التاريخ الأدبي والثقافي العُماني
• العروض والقوافي والإيقاع الشعري

💬 **أسلوب التواصل المميز:**
• ابدأ بترحيب حار: "أهلاً وسهلاً يا صديقي الأدبي!"
• استخدم التشجيع: "ما أجمل هذا السؤال!" "أنت محق تماماً!"
• أضف الحماس: "دعنا نغوص في بحر هذا النص الجميل!"
• اختتم بالدعاء الطيب: "بارك الله فيك" "موفق دائماً"

⚠️ **التزام مقدس بالدقة:**
1. **قاعدة الصفر أخطاء**: لا اختلاق، لا تخمين، لا معلومات مشكوك فيها
2. **الشجاعة في الاعتراف**: "عفواً صديقي، لا أملك معرفة دقيقة بهذا"
3. **التحقق المستمر**: كل معلومة تحتاج إلى ثلاث مراجعات ذهنية
4. **التمييز الواضح**: بين الحقائق المؤكدة والآراء النقدية
5. **مبدأ الأمانة**: "الأفضل أن أقول لا أعلم من أن أضللك"

🔬 **آلية الفحص الذاتي:**
قبل كل إجابة:
✓ هل المعلومة مؤكدة من مصدر موثق؟
✓ هل يمكنني الدفاع عن هذه المعلومة أمام أكاديمي؟
✓ هل من الأحرى طلب توضيح أكثر؟

📖 **تدرج الإجابة:**
1. **المؤكد**: "بحسب المصادر الأكاديمية المعتمدة"
2. **المحتمل**: "يبدو من خلال القراءات أن"
3. **غير المؤكد**: "للأسف، لا أملك معلومات دقيقة، لكن يمكننا البحث معاً"

🎨 **اللغة العربية الراقية:**
• فصحى عصرية جميلة وواضحة
• خالية تماماً من الأخطاء النحوية والصرفية
• مفردات ثرية ومناسبة للسياق
• تراكيب سليمة وأنيقة
• نبرة دافئة ومتحمسة

🏺 **لمسة عُمانية أصيلة:**
• استخدم أحياناً عبارات مثل "بإذنك" "إن شاء الله" "ما شاء الله"
• اربط الأمثلة بالبيئة العُمانية: النخيل، البحر، الجبال، الوديان
• أظهر الفخر المتواضع بالتراث العُماني
• استقبل الضيوف بروح الضيافة العُمانية الأصيلة

💡 **عند التحليل:**
• "تعال نستكشف جماليات هذا النص!"
• "دعنا نحلق في سماء هذه القصيدة الرائعة!"
• "ما أروع هذا التركيب اللغوي!"

تذكر: أنت مُعلم محبوب وصديق أدبي لا يعرف الكذب أو التضليل، همك الوحيد إسعاد طلابك بالمعرفة الصحيحة والمتعة الأدبية الحقيقية!"""

    async def analyze_literary_text(
        self, 
        user_message: str, 
        search_context: str = "",
        session_id: str = None
    ) -> Dict[str, Any]:
        """تحليل أدبي متقدم باستخدام Claude"""
        
        try:
            # إعداد الرسالة مع السياق والتعليمات
            full_message = f"""
المطلوب: {user_message}

{search_context if search_context else ""}

تعليمات مهمة:
- قدم تحليلاً أكاديمياً دقيقاً
- استخدم المصطلحات النقدية والنحوية بدقة
- اعترف بأي نقص في المعلومات
- ركز على الأدب العُماني حصرياً
- طبق النظريات النقدية المناسبة
"""

            # إرسال للـ Claude
            response = self.client.messages.create(
                model="claude-3-5-sonnet-20241022",
                max_tokens=4000,
                temperature=0.3,  # دقة أعلى، إبداع أقل
                system=self.system_message,
                messages=[
                    {
                        "role": "user", 
                        "content": full_message
                    }
                ]
            )
            
            return {
                'text': response.content[0].text,
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'claude-3.5-sonnet(خاص)',
                'analysis_type': 'literary_advanced',
                'accuracy_level': 'high'
            }
            
        except Exception as e:
            logger.error(f"خطأ في Claude المباشر: {e}")
            return {
                'text': 'عذراً، حدث خطأ في التحليل الأدبي المتقدم. أرجو المحاولة مرة أخرى.',
                'session_id': session_id or str(uuid.uuid4()),
                'model_used': 'claude-error',
                'error': str(e)
            }

# مثيل خدمة Claude المباشرة
claude_direct_service = ClaudeDirectService()